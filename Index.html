<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictPro Ultra V6</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. ROOT VARIABLES & RESET --- */
        :root {
            --bg-primary: #0a0c1f;
            --bg-secondary: #121533;
            --bg-tertiary: #1a1e4a;
            --bg-glass: rgba(26, 30, 74, 0.8);
            --border-color: rgba(136, 102, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b0b8d1;
            --brand-primary: #8866ff;
            --brand-secondary: #00e0ff;
            --brand-gradient: linear-gradient(135deg, var(--brand-secondary) 0%, var(--brand-primary) 100%);
            --brand-gradient-text: linear-gradient(135deg, var(--brand-secondary) 0%, var(--brand-primary) 100%);
            --success: #00ffaa;
            --danger: #ff4d6d;
            --warning: #ffcc00;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 40px rgba(136, 102, 255, 0.2);
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--text-primary);
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        a {
            color: var(--brand-primary);
            text-decoration: none;
        }

        /* --- 2. UTILITY CLASSES --- */
        .hidden {
            display: none !important;
        }

        .text-gradient {
            background: var(--brand-gradient-text);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.75em;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 50px;
            line-height: 1.5;
        }
        .badge-premium { background-color: var(--brand-primary); color: var(--text-primary); }
        .badge-admin { background-color: var(--brand-secondary); color: var(--bg-primary); }
        .badge-super { background: var(--warning); color: var(--bg-primary); }
        .badge-assistant { background-color: var(--text-secondary); color: var(--bg-primary); }
        .badge-success { background-color: var(--success); color: var(--bg-primary); }
        .badge-danger { background-color: var(--danger); color: var(--text-primary); }
        .badge-warning { background-color: var(--warning); color: var(--bg-primary); }
        .badge-inactive { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }

        /* --- 3. GLOBAL ELEMENTS (LOADER, MODAL, TOAST, BUTTONS) --- */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 12, 31, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--brand-secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        #loader-text {
            margin-top: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 12, 31, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            transition: opacity 0.3s ease;
            padding: 1rem;
        }
        .modal-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        #modal-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        #modal-close-btn:hover { color: var(--text-primary); }
        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        #notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 6000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            width: 320px;
            padding: 1rem 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left-width: 5px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
            font-weight: 500;
            animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: opacity 0.5s ease;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.danger { border-left-color: var(--danger); }
        
        .floating-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--brand-gradient);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            border: none;
        }
        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(136, 102, 255, 0.4);
        }
        #whatsapp-btn { bottom: 2rem; right: 2rem; }
        #support-btn { bottom: 2rem; left: 2rem; background: var(--bg-tertiary); border: 1px solid var(--brand-primary); }

        /* --- 4. FORM & BUTTON STYLES --- */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .btn-primary {
            background: var(--brand-gradient);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background-color: #2a2e5a; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-full { width: 100%; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(136, 102, 255, 0.3);
        }
        .form-group-inline {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .captcha-container {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        #captcha-canvas {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            flex-shrink: 0;
        }
        #captcha-input {
            letter-spacing: 0.2em;
            text-align: center;
            font-weight: 700;
        }
        #captcha-refresh {
            background: none;
            border: none;
            color: var(--brand-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .form-error {
            color: var(--danger);
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            margin-top: 1rem;
        }

        /* --- 5. AUTH SCREEN --- */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            animation: fadeIn 0.5s ease;
        }
        .auth-container {
            width: 100%;
            max-width: 420px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .auth-header {
            text-align: center;
            padding: 2rem 1rem 1rem;
        }
        .auth-header h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        .auth-toggle {
            display: flex;
            background: var(--bg-primary);
        }
        .auth-toggle-btn {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .auth-toggle-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--brand-primary);
        }
        .auth-form {
            padding: 2rem;
        }

        /* --- 6. APP CONTAINER --- */
        #app-container {
            display: flex;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #app-container.visible {
            opacity: 1;
        }

        #sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            transform: translateX(-100%);
        }
        #sidebar.open {
            transform: translateX(0);
            box-shadow: 10px 0 30px rgba(0,0,0,0.3);
        }
        .sidebar-header {
            padding-bottom: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }
        .profile-card {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .profile-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .nav-menu {
            flex-grow: 1;
            list-style: none;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .nav-link.active {
            background: var(--brand-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(136, 102, 255, 0.3);
        }
        .nav-link .nav-icon {
            font-size: 1.2rem;
            margin-right: 1rem;
            width: 20px;
            text-align: center;
        }
        #logout-btn {
            background: var(--bg-tertiary);
            color: var(--danger);
            border: 1px solid var(--danger);
            width: 100%;
        }
        #logout-btn:hover { background-color: rgba(255, 77, 109, 0.1); }

        /* --- 7. MAIN CONTENT --- */
        #main-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            transition: margin-left 0.3s ease-in-out;
            width: 100%;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        #page-title {
            font-size: 1.8rem;
            font-weight: 700;
        }
        #menu-toggle {
            display: block;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.8rem;
            cursor: pointer;
        }
        .page {
            animation: fadeIn 0.5s ease;
        }

        /* --- 8. DASHBOARD & CARDS --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--brand-primary);
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .card-body {
            padding: 1.5rem;
        }
        .stat-card {
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .stat-card .stat-icon {
            font-size: 2.5rem;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            opacity: 0.1;
            transform: rotate(-10deg);
        }
        .stat-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
            text-transform: uppercase;
        }
        .stat-card h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .countdown-timer {
            text-align: center;
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: var(--radius-md);
        }
        .countdown-timer p { margin-bottom: 0.5rem; }
        .countdown-timer h3 { font-size: 1.8rem; color: var(--warning); }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            width: 0;
            background: var(--brand-gradient);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .progress-text {
            text-align: center;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            height: 250px;
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            border: 1px solid var(--border-color);
        }
        .chart-bar {
            flex: 1;
            background: var(--brand-gradient);
            border-radius: 5px 5px 0 0;
            animation: growUp 1s ease;
        }
        @keyframes growUp { from { height: 0; } }

        .data-table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.85rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        .data-table th {
            background: var(--bg-tertiary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background-color: var(--bg-primary); }
        .data-table .action-btns { display: flex; gap: 0.5rem; }
        
        .predictor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .predictor-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .predictor-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--brand-primary);
        }
        .predictor-card .predictor-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .predictor-card h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        .payment-instructions {
            background: var(--bg-primary);
            border: 1px dashed var(--brand-primary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
        }
        .payment-instructions h4 {
            color: var(--brand-secondary);
            margin-bottom: 0.75rem;
        }
        .payment-instructions p {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .payment-instructions strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .list-group {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .list-group-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* --- 9. RESPONSIVENESS --- */
        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0);
                position: sticky;
            }
            #main-content {
                margin-left: 260px;
                width: calc(100% - 260px);
            }
            #menu-toggle {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            #whatsapp-btn { bottom: 1.5rem; right: 1.5rem; }
            #support-btn { bottom: 1.5rem; left: 1.5rem; }
            .modal-box {
                max-width: 95%;
            }
            .auth-container {
                max-width: 95%;
            }
            .captcha-container {
                flex-direction: column;
                align-items: stretch;
            }
            #captcha-canvas {
                width: 100%;
                height: 60px;
            }
            .data-table {
                font-size: 0.9rem;
            }
            .data-table th, .data-table td {
                padding: 0.75rem;
            }
            .data-table .action-btns {
                flex-direction: column;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

    </style>
</head>
<body>

    <!-- --- GLOBAL LOADER --- -->
    <div id="loader-overlay" class="hidden">
        <div class="loader-spinner"></div>
        <div id="loader-text">Loading...</div>
    </div>

    <!-- --- GLOBAL MODAL --- -->
    <div id="modal-overlay" class="hidden">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button id="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Modal content injected by JS -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Modal buttons injected by JS -->
            </div>
        </div>
    </div>

    <!-- --- GLOBAL TOAST CONTAINER --- -->
    <div id="notification-container"></div>

    <!-- --- FLOATING BUTTONS --- -->
    <a id="whatsapp-btn" class="floating-btn hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
            <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.606 2.922-6.528 6.53-6.528 1.743 0 3.37.68 4.603 1.913 1.23 1.23 1.913 2.86 1.913 4.603-.004 3.606-2.927 6.527-6.533 6.527zM6.062 7.511c-.267-.136-1.585-.78-1.83-..867-.244-.086-.42-.136-.6-.136s-.366.086-.52.272c-.156.187-.586.579-.719.697-.133.118-.267.136-.502.049-.234-.086-.994-.366-1.896-1.168-.71-.633-1.19-1.41-1.332-1.65-.143-.244-.012-.375.118-.502.118-.118.267-.29.4-.435.133-.143.176-.244.26-.41.086-.176.043-.318-.012-.447s-.6-.721-.82-.988c-.22-.267-.44-.234-.6-.234h-.244c-.21 0-.52.086-.719.366-.196.272-.719.867-.719 2.103 0 1.23.74 2.433.858 2.58.118.143 1.46 2.23 3.537 3.138.492.21.87.335 1.17.427.47.143.896.12.227.078.366-.043 1.18-.484 1.35-1.18.17-.704.17-1.29.118-1.41-.05-.118-.2-.187-.41-.318z"/>
        </svg>
    </a>
    <button id="support-btn" class="floating-btn hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/>
            <path d="M8.5 12a.5.5 0 0 1-1 0V9.5a.5.5 0 0 1 1 0v2.5z"/>
        </svg>
    </button>

    <!-- --- 1. AUTH SCREEN --- -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h1><span class="text-gradient">PredictPro</span> Ultra V6</h1>
            </div>
            <div class="auth-toggle">
                <button class="auth-toggle-btn active" data-form="login-form">Login</button>
                <button class="auth-toggle-btn" data-form="register-form">Register</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-email">Gmail Address</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <div class="form-group-inline">
                        <input type="password" id="login-password" required>
                        <button type="button" class="password-toggle" data-target="login-password">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>CAPTCHA Verification</label>
                    <div class="captcha-container">
                        <canvas id="login-captcha-canvas" width="200" height="70"></canvas>
                        <button type="button" id="login-captcha-refresh" class="captcha-refresh" title="Refresh CAPTCHA">&#x21bb;</button>
                    </div>
                    <input type="text" id="login-captcha-input" placeholder="Enter CAPTCHA (case-sensitive)" maxlength="8" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Login</button>
                <p id="login-error" class="form-error"></p>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="auth-form hidden">
                <div class="form-group">
                    <label for="register-email">Gmail Address</label>
                    <input type="email" id="register-email" placeholder="Only @gmail.com" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <div class="form-group-inline">
                        <input type="password" id="register-password" required>
                        <button type="button" class="password-toggle" data-target="register-password">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-ref-code">Referral Code (Optional)</label>
                    <input type="text" id="register-ref-code">
                </div>
                <div class="form-group">
                    <label>CAPTCHA Verification</label>
                    <div class="captcha-container">
                        <canvas id="register-captcha-canvas" width="200" height="70"></canvas>
                        <button type="button" id="register-captcha-refresh" class="captcha-refresh" title="Refresh CAPTCHA">&#x21bb;</button>
                    </div>
                    <input type="text" id="register-captcha-input" placeholder="Enter CAPTCHA (case-sensitive)" maxlength="8" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Register</button>
                <p id="register-error" class="form-error"></p>
            </form>
        </div>
    </div>

    <!-- --- 2. APP CONTAINER --- -->
    <div id="app-container" class="hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2><span class="text-gradient">PredictPro</span></h2>
            </div>
            <div class="profile-card">
                <h4 id="sidebar-username"></h4>
                <div id="sidebar-role-badge"></div>
            </div>
            <ul id="nav-menu" class="nav-menu">
                <!-- Nav links injected by JS -->
            </ul>
            <button id="logout-btn" class="btn"><span class="nav-icon">üö™</span> Logout</button>
        </aside>

        <!-- Main Content -->
        <main id="main-content">
            <header class="main-header">
                <h1 id="page-title">Dashboard</h1>
                <button id="menu-toggle" aria-label="Open Menu">‚ò∞</button>
            </header>

            <!-- 
            ==================================
            PAGES (Toggled by JS)
            ==================================
            -->

            <!-- --- USER: DASHBOARD --- -->
            <div id="page-user-dashboard" class="page dashboard-grid">
                <div class="card stat-card" style="grid-column: 1 / -1;">
                    <div class="stat-icon">üí∞</div>
                    <p>Referral Earnings</p>
                    <h2 id="user-stat-earnings">KES 0.00</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üéüÔ∏è</div>
                    <p>My Tickets</p>
                    <h2 id="user-stat-tickets">0</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">ü§ù</div>
                    <p>Active Referrals</p>
                    <h2 id="user-stat-referrals">0</h2>
                </div>
                
                <div id="user-premium-card" class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3>Your Status: <span id="user-stat-premium" class="badge badge-inactive">Normal</span></h3>
                    </div>
                    <div class="card-body" id="user-premium-body">
                        <p>Upgrade to Premium for discounts and extra prediction time!</p>
                        <button class="btn btn-primary" data-page="page-user-premium">View Plans</button>
                    </div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3>Active Licenses</h3>
                    </div>
                    <div class="card-body" id="user-licenses-body">
                        <p>You have no active licenses. Purchase one from the Predictors page.</p>
                    </div>
                </div>
            </div>

            <!-- --- USER: PREDICTORS --- -->
            <div id="page-user-predictors" class="page">
                <div class="predictor-grid" id="predictor-selection-grid">
                    <div class="predictor-card" data-type="crash">
                        <div class="predictor-icon">‚úàÔ∏è</div>
                        <h3>Crash Predictor</h3>
                        <button class="btn btn-primary">Get Access</button>
                    </div>
                    <div class="predictor-card" data-type="gems">
                        <div class="predictor-icon">üíé</div>
                        <h3>Gems Predictor</h3>
                        <button class="btn btn-primary">Get Access</button>
                    </div>
                    <div class="predictor-card" data-type="mines">
                        <div class="predictor-icon">üí£</div>
                        <h3>Mines Predictor</h3>
                        <button class="btn btn-primary">Get Access</button>
                    </div>
                    <div class="predictor-card" data-type="odds">
                        <div class="predictor-icon">‚öΩ</div>
                        <h3>Odds Predictions</h3>
                        <button class="btn btn-primary">Get Access</button>
                    </div>
                </div>
            </div>

            <!-- --- USER: PURCHASE FLOW --- -->
            <div id="page-user-purchase" class="page">
                <button class="btn btn-secondary" id="purchase-back-btn" style="margin-bottom: 1rem;">&larr; Back to Predictors</button>
                <div class="card">
                    <div class="card-header">
                        <h3 id="purchase-title">Purchase Access</h3>
                    </div>
                    <div class="card-body">
                        <!-- This content is dynamic -->
                        <div id="purchase-step-1">
                            <h4 style="margin-bottom: 1rem;">Pay <span id="purchase-price" class="text-gradient">KES 1500.00</span> to get 1-hour access.</h4>
                            <div class="payment-instructions">
                                <h4>M-Pesa Payment Instructions:</h4>
                                <p>1. Go to your M-Pesa Menu</p>
                                <p>2. Select "Lipa na M-Pesa"</p>
                                <p>3. Select "Pay Bill"</p>
                                <p>Business No: <strong id="payment-paybill">123456</strong></p>
                                <p>Account No: <strong id="payment-account">UltraPro</strong></p>
                                <p>Amount: <strong id="payment-amount">KES 1500</strong></p>
                            </div>
                            <br>
                            <p>After paying, enter your M-Pesa Transaction ID below to confirm. Payment is verified manually by an admin.</p>
                            <div class="form-group">
                                <label for="purchase-txid">M-Pesa TX ID (e.g., RKA123ABC)</label>
                                <input type="text" id="purchase-txid" placeholder="Enter your TX ID">
                            </div>
                            <button id="purchase-submit-txid-btn" class="btn btn-primary btn-full">Submit for Verification</button>
                        </div>

                        <div id="purchase-step-pending" class="hidden" style="text-align: center;">
                            <h3 class="text-gradient" style="margin-bottom: 1rem;">Payment Pending Approval</h3>
                            <p>Your transaction (<strong id="pending-txid">...</strong>) is being verified by an admin.</p>
                            <p>This may take a few minutes. Please check back soon.</p>
                            <div class="loader-spinner" style="width: 40px; height: 40px; margin: 1rem auto; border-top-color: var(--warning);"></div>
                        </div>

                        <div id="purchase-step-activating" class="hidden">
                            <h3 class="text-gradient" style="margin-bottom: 1rem;">Payment Approved!</h3>
                            <p id="activation-promo-msg" style="font-weight: 600; color: var(--warning);"></p>
                            <p>Activating your license... please wait.</p>
                            <div class="progress-bar-container" style="margin-top: 1.5rem;">
                                <div id="activation-progress-bar" class="progress-bar-inner"></div>
                            </div>
                            <p id="activation-progress-text" class="progress-text">Fetching predictions... 0%</p>
                        </div>
                        
                        <div id="purchase-step-license" class="hidden">
                            <h3 class="text-gradient" style="margin-bottom: 1rem;">License Activated!</h3>
                            <p>Here is your unique, one-time license key. It is bound to your email.</p>
                            <div class="form-group">
                                <label>Your License Key</label>
                                <input type="text" id="license-key-input" readonly>
                            </div>
                            <button id="copy-license-btn" class="btn btn-secondary">Copy Key</button>
                            <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                            <h4>Final Step: Deposit Check</h4>
                            <p>To ensure predictions match, please confirm you have deposited at least <strong>KES 799</strong> into your betting account.</p>
                            <div class="form-group">
                                <label>Upload Screenshot of Deposit</label>
                                <input type="file" id="deposit-screenshot-upload" class="form-group" style="padding: 10px;">
                            </div>
                            <button id="confirm-deposit-btn" class="btn btn-primary btn-full">Confirm Deposit & Start</button>
                        </div>
                        
                        <div id="purchase-step-rejected" class="hidden" style="text-align: center;">
                            <h3 style="color: var(--danger); margin-bottom: 1rem;">Payment Rejected</h3>
                            <p>Your transaction (<strong id="rejected-txid">...</strong>) was rejected.</p>
                            <p>Reason: <strong id="rejected-reason">...</strong></p>
                            <p>Please contact support or submit a valid transaction.</p>
                            <button id="rejected-try-again-btn" class="btn btn-primary" style="margin-top: 1rem;">Submit Another TX ID</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- --- USER: PREDICTOR ENGINE --- -->
            <div id="page-user-predictor-engine" class="page">
                <button class="btn btn-secondary" id="engine-back-btn" style="margin-bottom: 1rem;">&larr; Exit Predictor</button>
                <div class="card">
                    <div class="card-header">
                        <h3 id="engine-title">Crash Predictor</h3>
                        <div class="countdown-timer">
                            <p>Session Time Left</p>
                            <h3 id="engine-countdown">00:00:00</h3>
                        </div>
                    </div>
                    <div class="card-body" style="text-align: center;">
                        <p>Next Predicted Value:</p>
                        <h1 id="engine-prediction-value" style="font-size: 5rem; font-weight: 800; margin: 2rem 0;">--.--x</h1>
                        <button id="engine-next-btn" class="btn btn-primary btn-full" style="padding: 1rem; font-size: 1.2rem;">Get Next Prediction</button>
                        <p id="engine-cooldown-text" class="text-secondary" style="margin-top: 1rem;"></p>
                    </div>
                </div>
            </div>

            <!-- --- USER: REFERRALS --- -->
            <div id="page-user-referrals" class="page">
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3>Your Referral Link</h3>
                    </div>
                    <div class="card-body">
                        <p>Share this link to earn 10% commission on purchases and redeem points for rewards!</p>
                        <div class="form-group-inline" style="display: flex; gap: 0.5rem;">
                            <input type="text" id="referral-link-input" readonly>
                            <button id="copy-ref-link-btn" class="btn btn-secondary" style="flex-shrink: 0;">Copy</button>
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="card stat-card">
                        <div class="stat-icon">üìà</div>
                        <p>Total Earnings</p>
                        <h2 id="ref-stat-earnings">KES 0.00</h2>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">üë•</div>
                        <p>Total Referrals</p>
                        <h2 id="ref-stat-total">0</h2>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <p>Active Referrals</p>
                        <h2 id="ref-stat-active">0</h2>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">üéÅ</div>
                        <p>Referral Points</p>
                        <h2 id="ref-stat-points">0</h2>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3>Referral Activity (Mock Graph)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" id="referral-chart-mock">
                            <!-- Mock chart bars will be injected by JS -->
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3>My Referred Users</h3>
                    </div>
                    <div class="card-body data-table-container">
                        <table class="data-table" id="referral-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Commission Earned</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- --- USER: PREMIUM --- -->
            <div id="page-user-premium" class="page">
                <div class="predictor-grid" id="premium-plans-grid">
                    <!-- Premium plans injected by JS -->
                </div>
            </div>

            <!-- --- ASSISTANT: DASHBOARD --- -->
            <div id="page-assistant-dashboard" class="page">
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3>Assistant Dashboard</h3>
                    </div>
                    <div class="card-body">
                        <p>Welcome, Assistant. You can view support tickets and help users.</p>
                        <p>Your Status: <span id="assistant-duty-status" class="badge badge-success">On Duty</span></p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Support Tickets (Mock)</h3>
                    </div>
                    <div class="card-body data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user@gmail.com</td>
                                    <td>Payment not approved</td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                    <td>
                                        <div class="action-btns">
                                            <button class="btn btn-sm btn-secondary">View</button>
                                            <button class="btn btn-sm btn-primary">Escalate</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- --- ADMIN: DASHBOARD --- -->
            <div id="page-admin-dashboard" class="page dashboard-grid">
                <div class="card stat-card">
                    <div class="stat-icon">üí∏</div>
                    <p>Total Revenue (Mock)</p>
                    <h2 id="admin-stat-revenue">KES 0</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üë•</div>
                    <p>Active Users (24h)</p>
                    <h2 id="admin-stat-active-users">0</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <p>Pending Payments</p>
                    <h2 id="admin-stat-pending-payments">0</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üíé</div>
                    <p>Premium Users</p>
                    <h2 id="admin-stat-premium-users">0</h2>
                </div>
                
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3>Admin Actions</h3>
                    </div>
                    <div class="card-body" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="admin-broadcast-btn">Broadcast Message</button>
                        <button class="btn btn-secondary" id="admin-gen-assistant-btn">Generate Assistant</button>
                    </div>
                </div>
                
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3>Analytics (Mock)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" id="admin-chart-mock">
                            <!-- Mock chart bars will be injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- ADMIN: USERS --- -->
            <div id="page-admin-users" class="page card">
                <div class="card-header">
                    <h3>Manage Users</h3>
                </div>
                <div class="card-body data-table-container">
                    <table class="data-table" id="admin-users-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Premium</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- --- ADMIN: PAYMENTS --- -->
            <div id="page-admin-payments" class="page card">
                <div class="card-header">
                    <h3>Approve Payments</h3>
                </div>
                <div class="card-body data-table-container">
                    <table class="data-table" id="admin-payments-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>TX ID</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- --- ADMIN: SETTINGS --- -->
            <div id="page-admin-settings" class="page card">
                <div class="card-header">
                    <h3>System Settings</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="settings-whatsapp">Support WhatsApp Number (with +)</label>
                        <input type="text" id="settings-whatsapp">
                    </div>
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    <h4>Payment Details</h4>
                    <div class="form-group">
                        <label for="settings-paybill">M-Pesa Paybill</label>
                        <input type="text" id="settings-paybill">
                    </div>
                    <div class="form-group">
                        <label for="settings-account">M-Pesa Account</label>
                        <input type="text" id="settings-account">
                    </div>
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    <h4>Predictor Prices (KES)</h4>
                    <div class="form-group">
                        <label for="settings-price-crash">Crash Predictor</label>
                        <input type="number" id="settings-price-crash">
                    </div>
                    <div class="form-group">
                        <label for="settings-price-gems">Gems Predictor</label>
                        <input type="number" id="settings-price-gems">
                    </div>
                    <div class="form-group">
                        <label for="settings-price-mines">Mines Predictor</label>
                        <input type="number" id="settings-price-mines">
                    </div>
                    <div class="form-group">
                        <label for="settings-price-odds">Odds Predictions</label>
                        <input type="number" id="settings-price-odds">
                    </div>
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    <h4>Premium Prices (KES)</h4>
                    <div class="form-group">
                        <label for="settings-price-low">Low Premium</label>
                        <input type="number" id="settings-price-low">
                    </div>
                    <div class="form-group">
                        <label for="settings-price-mid">Mid Premium</label>
                        <input type="number" id="settings-price-mid">
                    </div>
                    <div class="form-group">
                        <label for="settings-price-high">High Premium</label>
                        <input type="number" id="settings-price-high">
                    </div>
                    <button id="admin-save-settings-btn" class="btn btn-primary">Save Settings</button>
                </div>
            </div>

            <!-- --- SUPER ADMIN: DASHBOARD --- -->
            <div id="page-super-dashboard" class="page dashboard-grid">
                <div class="card stat-card" style="grid-column: 1 / -1;">
                    <div class="stat-icon">üõ°Ô∏è</div>
                    <p>Super Admin Panel</p>
                    <h2>Full Control</h2>
                </div>
                 <div class="card stat-card">
                    <div class="stat-icon">üí∏</div>
                    <p>Total Revenue</p>
                    <h2 id="super-stat-revenue">KES 0</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üë•</div>
                    <p>Total Users</p>
                    <h2 id="super-stat-users">0</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üìà</div>
                    <p>Conversions</p>
                    <h2 id="super-stat-conversions">0%</h2>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon">üîÑ</div>
                    <p>Payment Trends</p>
                    <h2 id="super-stat-trends">Stable</h2>
                </div>
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-header">
                        <h3>Advanced Analytics (Mock)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" id="super-chart-mock">
                            <!-- Mock chart bars will be injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- --- SUPER ADMIN: AUDIT --- -->
            <div id="page-super-audit" class="page card">
                <div class="card-header">
                    <h3>Admin Audit Log</h3>
                </div>
                <div class="card-body data-table-container">
                    <table class="data-table" id="super-audit-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- --- SUPER ADMIN: MANAGE --- -->
            <div id="page-super-manage-admins" class="page card">
                <div class="card-header">
                    <h3>Manage Admins & Assistants</h3>
                </div>
                <div class="card-body data-table-container">
                    <table class="data-table" id="super-manage-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. STATE & APP CONTROLLER ---
            const App = {
                currentUser: null,
                currentCaptcha: { login: '', register: '' },
                loginAttempts: {},
                activeLicense: null,
                sessionTimer: null,
                predictionCooldown: null,
                
                init() {
                    App.showLoader("Initializing...");
                    DB.init();
                    App.addEventListeners();
                    
                    // Check for logged in user
                    const loggedInEmail = sessionStorage.getItem('predictProUser');
                    if (loggedInEmail) {
                        const user = DB.getUserByEmail(loggedInEmail);
                        if (user && !user.isSuspended) {
                            App.currentUser = user;
                            App.showApp();
                        } else {
                            if (user && user.isSuspended) {
                                App.showAlert(`Account suspended: ${user.suspendReason || 'Contact support.'}`, 'danger');
                            }
                            sessionStorage.removeItem('predictProUser');
                            App.showAuthScreen();
                        }
                    } else {
                        App.showAuthScreen();
                    }
                    App.hideLoader();
                },
                
                showApp() {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('visible');
                    document.getElementById('whatsapp-btn').classList.remove('hidden');
                    document.getElementById('support-btn').classList.remove('hidden');
                    
                    UI.buildApp(App.currentUser);
                },
                
                showAuthScreen() {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('visible');
                    document.getElementById('whatsapp-btn').classList.add('hidden');
                    document.getElementById('support-btn').classList.add('hidden');
                    
                    Auth.generateCaptcha('login');
                    Auth.generateCaptcha('register');
                },

                showLoader(text = "Loading...") {
                    document.getElementById('loader-text').textContent = text;
                    document.getElementById('loader-overlay').classList.remove('hidden');
                },

                hideLoader() {
                    document.getElementById('loader-overlay').classList.add('hidden');
                },

                showPage(pageId) {
                    document.querySelectorAll('#main-content .page').forEach(p => p.classList.add('hidden'));
                    const page = document.getElementById(pageId);
                    if (page) {
                        page.classList.remove('hidden');
                        const title = pageId.replace('page-', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        document.getElementById('page-title').textContent = title;
                        
                        // Close sidebar on nav in mobile
                        if (window.innerWidth < 1024) {
                            document.getElementById('sidebar').classList.remove('open');
                        }
                        
                        // Refresh data on page load
                        UI.refreshPageData(pageId);
                    } else {
                        console.error(`Page not found: ${pageId}`);
                    }
                },
                
                showAlert(message, type = 'success', duration = 5000) {
                    const container = document.getElementById('notification-container');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    
                    container.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 500);
                    }, duration);
                },
                
                showModal(title, bodyHtml, footerButtons = []) {
                    document.getElementById('modal-title').textContent = title;
                    document.getElementById('modal-body').innerHTML = bodyHtml;
                    const footer = document.getElementById('modal-footer');
                    footer.innerHTML = '';
                    
                    footerButtons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = `btn ${btn.class || 'btn-secondary'}`;
                        button.textContent = btn.text;
                        button.onclick = btn.action;
                        footer.appendChild(button);
                    });
                    
                    document.getElementById('modal-overlay').classList.remove('hidden');
                },
                
                hideModal() {
                    document.getElementById('modal-overlay').classList.add('hidden');
                },
                
                addEventListeners() {
                    // Auth
                    document.querySelectorAll('.auth-toggle-btn').forEach(btn => {
                        btn.addEventListener('click', () => UI.toggleAuthForm(btn.dataset.form));
                    });
                    document.getElementById('login-form').addEventListener('submit', Auth.handleLogin);
                    document.getElementById('register-form').addEventListener('submit', Auth.handleRegister);
                    document.querySelectorAll('.password-toggle').forEach(btn => {
                        btn.addEventListener('click', () => Auth.togglePassword(btn));
                    });
                    document.getElementById('login-captcha-refresh').addEventListener('click', () => Auth.generateCaptcha('login'));
                    document.getElementById('register-captcha-refresh').addEventListener('click', () => Auth.generateCaptcha('register'));
                    
                    // App Shell
                    document.getElementById('logout-btn').addEventListener('click', Auth.handleLogout);
                    document.getElementById('menu-toggle').addEventListener('click', UI.toggleSidebar);
                    
                    // Modals
                    document.getElementById('modal-close-btn').addEventListener('click', App.hideModal);
                    document.getElementById('modal-overlay').addEventListener('click', (e) => {
                        if (e.target.id === 'modal-overlay') App.hideModal();
                    });
                    
                    // Floating Buttons
                    document.getElementById('whatsapp-btn').addEventListener('click', Support.openWhatsApp);
                    document.getElementById('support-btn').addEventListener('click', Support.showSupportModal);
                    
                    // Dynamic Nav
                    document.getElementById('nav-menu').addEventListener('click', (e) => {
                        const link = e.target.closest('.nav-link');
                        if (link) {
                            e.preventDefault();
                            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                            link.classList.add('active');
                            App.showPage(link.dataset.page);
                        }
                    });
                    
                    // Predictor Flow
                    document.getElementById('predictor-selection-grid').addEventListener('click', (e) => {
                        const card = e.target.closest('.predictor-card');
                        if (card) {
                            Predictor.selectPredictor(card.dataset.type);
                        }
                    });
                    document.getElementById('purchase-back-btn').addEventListener('click', () => App.showPage('page-user-predictors'));
                    document.getElementById('purchase-submit-txid-btn').addEventListener('click', Predictor.submitPayment);
                    document.getElementById('rejected-try-again-btn').addEventListener('click', () => UI.showPurchaseStep('purchase-step-1'));
                    document.getElementById('copy-license-btn').addEventListener('click', Predictor.copyLicense);
                    document.getElementById('confirm-deposit-btn').addEventListener('click', Predictor.confirmDeposit);
                    document.getElementById('engine-back-btn').addEventListener('click', Predictor.exitEngine);
                    document.getElementById('engine-next-btn').addEventListener('click', Predictor.getNextPrediction);
                    
                    // Referrals
                    document.getElementById('copy-ref-link-btn').addEventListener('click', Referral.copyReferralLink);
                    
                    // Admin
                    document.getElementById('admin-save-settings-btn')?.addEventListener('click', Admin.saveSettings);
                    document.getElementById('admin-broadcast-btn')?.addEventListener('click', Admin.showBroadcastModal);
                    document.getElementById('admin-gen-assistant-btn')?.addEventListener('click', Admin.showGenerateAssistantModal);
                    
                    // Dynamic Listeners for Tables
                    document.body.addEventListener('click', (e) => {
                        const target = e.target.closest('[data-action]');
                        if (!target) return;
                        
                        const action = target.dataset.action;
                        const id = target.dataset.id;
                        
                        switch(action) {
                            case 'admin-approve-payment': Admin.approvePayment(id); break;
                            case 'admin-reject-payment': Admin.showRejectModal(id); break;
                            case 'admin-ban-user': Admin.showBanModal(id); break;
                            case 'admin-unban-user': Admin.unbanUser(id); break;
                            case 'admin-grant-premium': Admin.showGrantPremiumModal(id); break;
                            case 'super-promote-admin': SuperAdmin.showManageRoleModal(id, 'admin'); break;
                            case 'super-promote-assistant': SuperAdmin.showManageRoleModal(id, 'assistant'); break;
                            case 'super-demote-user': SuperAdmin.demoteToUser(id); break;
                        }
                    });
                }
            };
            
            // --- 2. DATABASE (LocalStorage) ---
            const DB = {
                init() {
                    const now = Date.now();
                    const mockUsers = [
                        { email: 'user@gmail.com', password: '123', role: 'user', isSuspended: false, premiumTier: null, premiumExpiry: null, tickets: 0, points: 0, refCode: 'REF-USER1', referredBy: 'REF-ADMIN1' },
                        { email: 'user2@gmail.com', password: '123', role: 'user', isSuspended: false, premiumTier: 'low', premiumExpiry: now + 7 * 24 * 60 * 60 * 1000, tickets: 5, points: 50, refCode: 'REF-USER2', referredBy: 'REF-USER1' },
                        { email: 'banned@gmail.com', password: '123', role: 'user', isSuspended: true, suspendReason: 'Fraud attempt', premiumTier: null, premiumExpiry: null, tickets: 0, points: 0, refCode: 'REF-BANNED', referredBy: null },
                        { email: 'assistant@gmail.com', password: '123', role: 'assistant', isSuspended: false, premiumTier: null, premiumExpiry: null, tickets: 0, points: 0, refCode: 'REF-ASST1', referredBy: null, assistantExpiry: now + 30 * 24 * 60 * 60 * 1000, isOnDuty: true },
                        { email: 'admin@gmail.com', password: '123', role: 'admin', isSuspended: false, premiumTier: null, premiumExpiry: null, tickets: 0, points: 0, refCode: 'REF-ADMIN1', referredBy: null },
                        { email: 'super@gmail.com', password: '123', role: 'super-admin', isSuspended: false, premiumTier: null, premiumExpiry: null, tickets: 0, points: 0, refCode: 'REF-SUPER1', referredBy: null }
                    ];
                    const mockPayments = [
                        { id: 'p1', userId: 'user@gmail.com', txId: 'RKA123', amount: 1500, type: 'crash', status: 'pending', submittedAt: now - 3600000 },
                        { id: 'p2', userId: 'user2@gmail.com', txId: 'RKB456', amount: 300, type: 'premium-low', status: 'approved', submittedAt: now - 86400000, approvedBy: 'admin@gmail.com', approvedAt: now - 86300000 },
                        { id: 'p3', userId: 'user@gmail.com', txId: 'RKC789', amount: 1500, type: 'gems', status: 'rejected', reason: 'Invalid TX ID', submittedAt: now - 7200000, rejectedBy: 'admin@gmail.com', rejectedAt: now - 7100000 }
                    ];
                    const mockLicenses = [
                        { id: 'L1', userId: 'user2@gmail.com', type: 'gems', key: 'ULTRA-GEMS-AB12-CD34', createdAt: now - 3600000, expiry: now + 3600000 } // Active license
                    ];
                    const mockSettings = {
                        whatsapp: '+254700123456',
                        payment: { paybill: '123456', account: 'UltraPro' },
                        prices: { crash: 1500, gems: 1500, mines: 1500, odds: 1000 },
                        premium: { low: 300, mid: 700, high: 1500 }
                    };
                    const mockAuditLog = [
                        { id: 'a1', timestamp: now - 86300000, admin: 'admin@gmail.com', action: 'Approved Payment', details: 'TX RKB456 for user2@gmail.com' }
                    ];
                    
                    if (!localStorage.getItem('predictPro_users')) DB.set('users', mockUsers);
                    if (!localStorage.getItem('predictPro_payments')) DB.set('payments', mockPayments);
                    if (!localStorage.getItem('predictPro_licenses')) DB.set('licenses', mockLicenses);
                    if (!localStorage.getItem('predictPro_settings')) DB.set('settings', mockSettings);
                    if (!localStorage.getItem('predictPro_auditLog')) DB.set('auditLog', mockAuditLog);
                },
                
                get(key) {
                    try {
                        return JSON.parse(localStorage.getItem(`predictPro_${key}`));
                    } catch (e) { return null; }
                },
                set(key, value) {
                    try {
                        localStorage.setItem(`predictPro_${key}`, JSON.stringify(value));
                    } catch (e) { console.error(`Failed to set ${key} in localStorage`, e); }
                },
                
                // --- Data Helpers ---
                getAllUsers() { return DB.get('users') || []; },
                getUserByEmail(email) { return DB.getAllUsers().find(u => u.email.toLowerCase() === email.toLowerCase()); },
                updateUser(email, updates) {
                    let users = DB.getAllUsers();
                    let userIndex = users.findIndex(u => u.email.toLowerCase() === email.toLowerCase());
                    if (userIndex > -1) {
                        users[userIndex] = { ...users[userIndex], ...updates };
                        DB.set('users', users);
                        return users[userIndex];
                    }
                    return null;
                },
                addUser(user) {
                    let users = DB.getAllUsers();
                    users.push(user);
                    DB.set('users', users);
                },
                
                getAllPayments() { return DB.get('payments') || []; },
                getPaymentById(id) { return DB.getAllPayments().find(p => p.id === id); },
                getPendingPayments() { return DB.getAllPayments().filter(p => p.status === 'pending'); },
                addPayment(payment) {
                    let payments = DB.getAllPayments();
                    payments.push(payment);
                    DB.set('payments', payments);
                },
                updatePayment(id, updates) {
                    let payments = DB.getAllPayments();
                    let paymentIndex = payments.findIndex(p => p.id === id);
                    if (paymentIndex > -1) {
                        payments[paymentIndex] = { ...payments[paymentIndex], ...updates };
                        DB.set('payments', payments);
                        return payments[paymentIndex];
                    }
                    return null;
                },
                
                getSettings() { return DB.get('settings'); },
                setSettings(newSettings) { DB.set('settings', newSettings); },
                
                getAllLicenses() { return DB.get('licenses') || []; },
                getActiveLicenses(userId) {
                    const now = Date.now();
                    return DB.getAllLicenses().filter(l => l.userId === userId && l.expiry > now);
                },
                addLicense(license) {
                    let licenses = DB.getAllLicenses();
                    licenses.push(license);
                    DB.set('licenses', licenses);
                },
                
                getAuditLog() { return DB.get('auditLog') || []; },
                logAction(adminEmail, action, details) {
                    let log = DB.getAuditLog();
                    log.push({
                        id: `a${Date.now()}`,
                        timestamp: Date.now(),
                        admin: adminEmail,
                        action: action,
                        details: details
                    });
                    DB.set('auditLog', log);
                }
            };
            
            // --- 3. AUTHENTICATION ---
            const Auth = {
                handleLogin(e) {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value.toLowerCase();
                    const password = document.getElementById('login-password').value;
                    const captcha = document.getElementById('login-captcha-input').value;
                    
                    const attempts = App.loginAttempts[email] || 0;
                    if (attempts >= 5) {
                        const lockTime = (App.loginAttempts[email + '_lock'] || 0) + 3600000; // 1 hour
                        if (Date.now() < lockTime) {
                            document.getElementById('login-error').textContent = `Too many failed attempts. Try again in ${Math.ceil((lockTime - Date.now()) / 60000)} minutes.`;
                            return;
                        } else {
                            delete App.loginAttempts[email];
                            delete App.loginAttempts[email + '_lock'];
                        }
                    }
                    
                    if (captcha !== App.currentCaptcha.login) {
                        document.getElementById('login-error').textContent = 'Invalid CAPTCHA. Please try again.';
                        App.loginAttempts[email] = (App.loginAttempts[email] || 0) + 1;
                        if (App.loginAttempts[email] >= 5) App.loginAttempts[email + '_lock'] = Date.now();
                        Auth.generateCaptcha('login');
                        return;
                    }
                    
                    const user = DB.getUserByEmail(email);
                    
                    if (user && user.password === password) {
                        if (user.isSuspended) {
                            document.getElementById('login-error').textContent = `Account suspended: ${user.suspendReason || 'Contact support.'}`;
                            return;
                        }
                        
                        // SUCCESS
                        delete App.loginAttempts[email];
                        App.currentUser = user;
                        sessionStorage.setItem('predictProUser', user.email);
                        App.showApp();
                        
                    } else {
                        // FAILURE
                        document.getElementById('login-error').textContent = 'Invalid email, password, or CAPTCHA.';
                        App.loginAttempts[email] = (App.loginAttempts[email] || 0) + 1;
                        if (App.loginAttempts[email] >= 5) App.loginAttempts[email + '_lock'] = Date.now();
                        Auth.generateCaptcha('login');
                    }
                },
                
                handleRegister(e) {
                    e.preventDefault();
                    const email = document.getElementById('register-email').value.toLowerCase();
                    const password = document.getElementById('register-password').value;
                    const refCode = document.getElementById('register-ref-code').value;
                    const captcha = document.getElementById('register-captcha-input').value;
                    const errorEl = document.getElementById('register-error');

                    if (!email.endsWith('@gmail.com')) {
                        errorEl.textContent = 'Only @gmail.com addresses are allowed.';
                        return;
                    }
                    if (Auth.isDisposable(email)) {
                        errorEl.textContent = 'Disposable email addresses are not allowed.';
                        // Auto-ban this email domain (simulated)
                        console.warn(`BANNED (simulated): ${email}`);
                        return;
                    }
                    if (password.length < 6) {
                        errorEl.textContent = 'Password must be at least 6 characters.';
                        return;
                    }
                    if (captcha !== App.currentCaptcha.register) {
                        errorEl.textContent = 'Invalid CAPTCHA. Please try again.';
                        Auth.generateCaptcha('register');
                        return;
                    }
                    if (DB.getUserByEmail(email)) {
                        errorEl.textContent = 'An account with this email already exists.';
                        Auth.generateCaptcha('register');
                        return;
                    }
                    
                    // Find referrer
                    let referredBy = null;
                    if (refCode) {
                        const users = DB.getAllUsers();
                        const referrer = users.find(u => u.refCode === refCode);
                        if (referrer) {
                            referredBy = referrer.refCode;
                            // Add points to referrer (simulated)
                            DB.updateUser(referrer.email, { points: (referrer.points || 0) + 10 });
                        }
                    }
                    
                    const newUser = {
                        email: email,
                        password: password, // In real app, HASH this
                        role: 'user',
                        isSuspended: false,
                        premiumTier: null,
                        premiumExpiry: null,
                        tickets: 0,
                        points: 0,
                        refCode: `REF-${email.split('@')[0].toUpperCase()}${Date.now().toString(36).slice(-4)}`,
                        referredBy: referredBy
                    };
                    
                    DB.addUser(newUser);
                    
                    App.showAlert('Registration successful! Please log in.', 'success');
                    UI.toggleAuthForm('login-form');
                    document.getElementById('login-email').value = email;
                },
                
                handleLogout() {
                    App.showLoader("Logging out...");
                    sessionStorage.removeItem('predictProUser');
                    App.currentUser = null;
                    if (App.sessionTimer) clearInterval(App.sessionTimer);
                    if (App.predictionCooldown) clearTimeout(App.predictionCooldown);
                    App.activeLicense = null;
                    
                    setTimeout(() => {
                        App.hideLoader();
                        App.showAuthScreen();
                    }, 500);
                },
                
                isDisposable(email) {
                    // Mock check
                    const disposableDomains = ['disposable.com', 'temp-mail.org', '10minutemail.com'];
                    const domain = email.split('@')[1];
                    return disposableDomains.includes(domain);
                },
                
                generateCaptcha(type) {
                    const canvas = document.getElementById(`${type}-captcha-canvas`);
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                    let code = '';
                    for (let i = 0; i < 8; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    App.currentCaptcha[type] = code;
                    
                    // Draw
                    ctx.fillStyle = '#0a0c1f';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Noise lines
                    for (let i = 0; i < 5; i++) {
                        ctx.strokeStyle = `rgba(136, 102, 255, ${Math.random() * 0.3 + 0.1})`;
                        ctx.beginPath();
                        ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                        ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                        ctx.stroke();
                    }

                    // Text
                    ctx.font = 'bold 30px Poppins';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const textWidth = canvas.width / code.length;
                    for (let i = 0; i < code.length; i++) {
                        ctx.fillStyle = `rgba(${Math.random()*100+155}, ${Math.random()*100+155}, ${Math.random()*100+155}, ${Math.random()*0.5 + 0.5})`;
                        ctx.save();
                        ctx.translate(i * textWidth + textWidth / 2, canvas.height / 2 + (Math.random() * 10 - 5));
                        ctx.rotate((Math.random() - 0.5) * 0.4);
                        ctx.fillText(code[i], 0, 0);
                        ctx.restore();
                    }
                },
                
                togglePassword(icon) {
                    const targetId = icon.dataset.target;
                    const input = document.getElementById(targetId);
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.textContent = 'üôà';
                    } else {
                        input.type = 'password';
                        icon.textContent = 'üëÅÔ∏è';
                    }
                }
            };
            
            // --- 4. UI/DOM MANIPULATION ---
            const UI = {
                toggleAuthForm(formId) {
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('register-form').classList.add('hidden');
                    document.getElementById(formId).classList.remove('hidden');
                    
                    document.querySelectorAll('.auth-toggle-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`[data-form="${formId}"]`).classList.add('active');
                },
                
                toggleSidebar() {
                    document.getElementById('sidebar').classList.toggle('open');
                },
                
                buildApp(user) {
                    UI.renderSidebar(user.role);
                    UI.updateGlobalUI(user);
                    
                    // Set default page
                    const firstLink = document.querySelector('#nav-menu .nav-link');
                    if (firstLink) {
                        firstLink.classList.add('active');
                        App.showPage(firstLink.dataset.page);
                    }
                },
                
                updateGlobalUI(user) {
                    document.getElementById('sidebar-username').textContent = user.email.split('@')[0];
                    const badge = document.getElementById('sidebar-role-badge');
                    let badgeClass = 'badge-inactive';
                    let badgeText = user.role;
                    
                    if (user.role === 'admin') badgeClass = 'badge-admin';
                    if (user.role === 'super-admin') badgeClass = 'badge-super';
                    if (user.role === 'assistant') badgeClass = 'badge-assistant';
                    if (user.role === 'user' && user.premiumTier) {
                        badgeClass = 'badge-premium';
                        badgeText = `${user.premiumTier} Premium`;
                    }
                    badge.innerHTML = `<span class="badge ${badgeClass}">${badgeText}</span>`;
                    
                    const settings = DB.getSettings();
                    document.getElementById('whatsapp-btn').href = `https://wa.me/${settings.whatsapp.replace('+', '')}`;
                },
                
                renderSidebar(role) {
                    const menu = document.getElementById('nav-menu');
                    let links = '';
                    
                    const navs = {
                        user: [
                            { page: 'page-user-dashboard', icon: 'üè†', text: 'Dashboard' },
                            { page: 'page-user-predictors', icon: '‚úàÔ∏è', text: 'Predictors' },
                            { page: 'page-user-referrals', icon: 'ü§ù', text: 'Referrals' },
                            { page: 'page-user-premium', icon: 'üíé', text: 'Premium Plans' },
                        ],
                        assistant: [
                            { page: 'page-assistant-dashboard', icon: 'üè†', text: 'Dashboard' },
                        ],
                        admin: [
                            { page: 'page-admin-dashboard', icon: 'üè†', text: 'Dashboard' },
                            { page: 'page-admin-payments', icon: 'üí∏', text: 'Payments' },
                            { page: 'page-admin-users', icon: 'üë•', text: 'Manage Users' },
                            { page: 'page-admin-settings', icon: '‚öôÔ∏è', text: 'Settings' },
                        ],
                        'super-admin': [
                            { page: 'page-super-dashboard', icon: 'üõ°Ô∏è', text: 'Super Dashboard' },
                            { page: 'page-admin-payments', icon: 'üí∏', text: 'All Payments' },
                            { page: 'page-admin-users', icon: 'üë•', text: 'All Users' },
                            { page: 'page-super-manage-admins', icon: 'üëë', text: 'Manage Staff' },
                            { page: 'page-super-audit', icon: 'üìú', text: 'Audit Log' },
                            { page: 'page-admin-settings', icon: '‚öôÔ∏è', text: 'Global Settings' },
                        ]
                    };
                    
                    const roleNav = navs[role] || navs.user;
                    roleNav.forEach(link => {
                        links += `
                            <li>
                                <a href="#" class="nav-link" data-page="${link.page}">
                                    <span class="nav-icon">${link.icon}</span> ${link.text}
                                </a>
                            </li>
                        `;
                    });
                    menu.innerHTML = links;
                },
                
                refreshPageData(pageId) {
                    switch(pageId) {
                        case 'page-user-dashboard': UI.renderUserDashboard(); break;
                        case 'page-user-referrals': Referral.renderReferralPage(); break;
                        case 'page-user-premium': UI.renderPremiumPlans(); break;
                        case 'page-admin-dashboard': Admin.renderDashboard(); break;
                        case 'page-admin-users': Admin.renderUserList(); break;
                        case 'page-admin-payments': Admin.renderPaymentList(); break;
                        case 'page-admin-settings': Admin.loadSettings(); break;
                        case 'page-super-dashboard': SuperAdmin.renderDashboard(); break;
                        case 'page-super-audit': SuperAdmin.renderAuditLog(); break;
                        case 'page-super-manage-admins': SuperAdmin.renderManageAdmins(); break;
                    }
                },
                
                renderUserDashboard() {
                    const user = App.currentUser;
                    const referrals = DB.getAllUsers().filter(u => u.referredBy === user.refCode);
                    const activeReferrals = referrals.filter(u => !u.isSuspended); // Simple logic
                    
                    // Mock earnings
                    const earnings = Referral.calculateTotalEarnings(user.email);
                    document.getElementById('user-stat-earnings').textContent = `KES ${earnings.toFixed(2)}`;
                    document.getElementById('user-stat-tickets').textContent = user.tickets;
                    document.getElementById('user-stat-referrals').textContent = activeReferrals.length;
                    
                    if (user.premiumTier) {
                        document.getElementById('user-stat-premium').textContent = `${user.premiumTier} Premium`;
                        document.getElementById('user-stat-premium').className = 'badge badge-premium';
                        document.getElementById('user-premium-body').innerHTML = `
                            <p>Your premium access is active until:</p>
                            <h4 style="margin-bottom: 1rem;">${new Date(user.premiumExpiry).toLocaleString()}</h4>
                            <p>You get 10% off purchases and +10 min on licenses.</p>
                        `;
                    } else {
                        document.getElementById('user-stat-premium').textContent = 'Normal';
                        document.getElementById('user-stat-premium').className = 'badge badge-inactive';
                        document.getElementById('user-premium-body').innerHTML = `
                            <p>Upgrade to Premium for discounts and extra prediction time!</p>
                            <button class="btn btn-primary" id="dash-upgrade-btn">View Plans</button>
                        `;
                        document.getElementById('dash-upgrade-btn')?.addEventListener('click', () => App.showPage('page-user-premium'));
                    }
                    
                    // Render active licenses
                    const licenses = DB.getActiveLicenses(user.email);
                    const licensesBody = document.getElementById('user-licenses-body');
                    if (licenses.length > 0) {
                        licensesBody.innerHTML = licenses.map(lic => `
                            <div class="list-group-item">
                                <div>
                                    <h5 style="text-transform: capitalize;">${lic.type} Predictor License</h5>
                                    <p style="margin:0; font-size: 0.9rem;">Expires: ${new Date(lic.expiry).toLocaleTimeString()}</p>
                                </div>
                                <button class="btn btn-sm btn-primary" data-type="${lic.type}" id="btn-start-lic-${lic.id}">Start Session</button>
                            </div>
                        `).join('');
                        licensesBody.querySelectorAll('button[id^="btn-start-lic-"]').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const type = e.target.dataset.type;
                                const license = DB.getActiveLicenses(user.email).find(l => l.type === type);
                                Predictor.startPredictionEngine(license);
                            });
                        });
                    } else {
                        licensesBody.innerHTML = '<p>You have no active licenses. Purchase one from the Predictors page.</p>';
                    }
                },
                
                renderPremiumPlans() {
                    const settings = DB.getSettings();
                    const grid = document.getElementById('premium-plans-grid');
                    grid.innerHTML = `
                        <div class="predictor-card" data-type="premium-low">
                            <div class="predictor-icon">üíé</div>
                            <h3>Low Premium</h3>
                            <h4>KES ${settings.premium.low}</h4>
                            <p style="color: var(--text-secondary); margin: 1rem 0;">Valid for 3-7 days. 10% discount.</p>
                            <button class="btn btn-primary">Purchase</button>
                        </div>
                        <div class="predictor-card" data-type="premium-mid">
                            <div class="predictor-icon">üíéüíé</div>
                            <h3>Mid Premium</h3>
                            <h4>KES ${settings.premium.mid}</h4>
                            <p style="color: var(--text-secondary); margin: 1rem 0;">Valid for 14 days. 10% discount.</p>
                            <button class="btn btn-primary">Purchase</button>
                        </div>
                        <div class="predictor-card" data-type="premium-high">
                            <div class="predictor-icon">üíéüíéüíé</div>
                            <h3>High Premium</h3>
                            <h4>KES ${settings.premium.high}</h4>
                            <p style="color: var(--text-secondary); margin: 1rem 0;">Valid for 30 days. Full control. Request Assistant Access.</p>
                            <button class="btn btn-primary">Purchase</button>
                        </div>
                    `;
                    // Add click listeners to purchase
                    grid.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const type = e.target.closest('.predictor-card').dataset.type;
                            Predictor.selectPredictor(type);
                        });
                    });
                },
                
                showPurchaseStep(stepId) {
                    ['purchase-step-1', 'purchase-step-pending', 'purchase-step-activating', 'purchase-step-license', 'purchase-step-rejected'].forEach(id => {
                        document.getElementById(id).classList.add('hidden');
                    });
                    document.getElementById(stepId).classList.remove('hidden');
                },
                
                renderMockChart(containerId, bars = 7, maxVal = 100) {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    container.innerHTML = '';
                    for (let i = 0; i < bars; i++) {
                        const bar = document.createElement('div');
                        bar.className = 'chart-bar';
                        const height = (Math.random() * (maxVal - 10) + 10) / maxVal * 100;
                        bar.style.height = `${height}%`;
                        container.appendChild(bar);
                    }
                }
            };

            // --- 5. PREDICTOR & PAYMENT FLOW ---
            const Predictor = {
                currentPurchase: { type: null, price: 0 },
                
                selectPredictor(type) {
                    // Check for existing active license
                    const activeLicense = DB.getActiveLicenses(App.currentUser.email).find(l => l.type === type);
                    if (activeLicense) {
                        App.showAlert("You already have an active license for this.", 'warning');
                        Predictor.startPredictionEngine(activeLicense);
                        return;
                    }
                    
                    // Check for pending/approved payment
                    const payments = DB.getAllPayments();
                    const existingPayment = payments.find(p => p.userId === App.currentUser.email && p.type === type && (p.status === 'pending' || p.status === 'approved'));
                    
                    if (existingPayment) {
                        if (existingPayment.status === 'pending') {
                            Predictor.showPendingScreen(existingPayment);
                        } else if (existingPayment.status === 'approved') {
                            Predictor.startActivation(existingPayment);
                        }
                    } else {
                        // New purchase flow
                        Predictor.showPaymentScreen(type);
                    }
                },
                
                showPaymentScreen(type) {
                    const settings = DB.getSettings();
                    let price, title;
                    
                    if (type.startsWith('premium-')) {
                        const tier = type.split('-')[1];
                        price = settings.premium[tier];
                        title = `${tier.charAt(0).toUpperCase() + tier.slice(1)} Premium`;
                    } else {
                        price = settings.prices[type];
                        title = `${type.charAt(0).toUpperCase() + type.slice(1)} Predictor`;
                    }
                    
                    // Apply premium discount
                    let finalPrice = price;
                    if (App.currentUser.premiumTier) {
                        finalPrice = price * 0.90; // 10% discount
                    }
                    
                    Predictor.currentPurchase = { type, price: finalPrice };
                    
                    document.getElementById('purchase-title').textContent = `Purchase ${title}`;
                    document.getElementById('purchase-price').textContent = `KES ${finalPrice.toFixed(2)}`;
                    document.getElementById('payment-paybill').textContent = settings.payment.paybill;
                    document.getElementById('payment-account').textContent = settings.payment.account;
                    document.getElementById('payment-amount').textContent = `KES ${finalPrice.toFixed(2)}`;
                    document.getElementById('purchase-txid').value = '';
                    
                    UI.showPurchaseStep('purchase-step-1');
                    App.showPage('page-user-purchase');
                },
                
                submitPayment() {
                    const txId = document.getElementById('purchase-txid').value.trim().toUpperCase();
                    if (!txId) {
                        App.showAlert("Please enter a Transaction ID.", 'danger');
                        return;
                    }
                    
                    const newPayment = {
                        id: `p${Date.now()}`,
                        userId: App.currentUser.email,
                        txId: txId,
                        amount: Predictor.currentPurchase.price,
                        type: Predictor.currentPurchase.type,
                        status: 'pending',
                        submittedAt: Date.now()
                    };
                    
                    DB.addPayment(newPayment);
                    Predictor.showPendingScreen(newPayment);
                },
                
                showPendingScreen(payment) {
                    document.getElementById('pending-txid').textContent = payment.txId;
                    UI.showPurchaseStep('purchase-step-pending');
                    App.showPage('page-user-purchase');
                },
                
                showRejectedScreen(payment) {
                    document.getElementById('rejected-txid').textContent = payment.txId;
                    document.getElementById('rejected-reason').textContent = payment.reason || 'No reason provided.';
                    UI.showPurchaseStep('purchase-step-rejected');
                    App.showPage('page-user-purchase');
                },
                
                startActivation(payment) {
                    UI.showPurchaseStep('purchase-step-activating');
                    App.showPage('page-user-purchase');
                    
                    document.getElementById('activation-promo-msg').textContent = "Important: For predictions to match, you must create your betting account using Promo Code: KING404";
                    
                    let progress = 0;
                    const progressBar = document.getElementById('activation-progress-bar');
                    const progressText = document.getElementById('activation-progress-text');
                    
                    const interval = setInterval(() => {
                        progress += Math.floor(Math.random() * 15) + 5;
                        if (progress > 100) progress = 100;
                        
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `Fetching right predictions for your account... ${progress}%`;
                        
                        if (progress === 100) {
                            clearInterval(interval);
                            setTimeout(() => {
                                Predictor.createLicense(payment);
                            }, 500);
                        }
                    }, 400);
                },
                
                createLicense(payment) {
                    const now = Date.now();
                    let duration = 60 * 60 * 1000; // 60 minutes
                    if (App.currentUser.premiumTier) {
                        duration += 10 * 60 * 1000; // +10 mins (70 total)
                    }
                    
                    const newLicense = {
                        id: `L${Date.now()}`,
                        userId: App.currentUser.email,
                        type: payment.type,
                        key: `ULTRA-${payment.type.toUpperCase()}-${Date.now().toString(36).slice(-4)}-${App.currentUser.email.slice(0, 3).toUpperCase()}`,
                        createdAt: now,
                        expiry: now + duration
                    };
                    
                    DB.addLicense(newLicense);
                    
                    // Mark payment as used
                    DB.updatePayment(payment.id, { status: 'used', licenseId: newLicense.id });
                    
                    document.getElementById('license-key-input').value = newLicense.key;
                    UI.showPurchaseStep('purchase-step-license');
                },
                
                copyLicense() {
                    const input = document.getElementById('license-key-input');
                    input.select();
                    input.setSelectionRange(0, 99999);
                    try {
                        document.execCommand('copy');
                        App.showAlert('License key copied!', 'success');
                    } catch (err) {
                        App.showAlert('Failed to copy key.', 'danger');
                    }
                },
                
                confirmDeposit() {
                    const upload = document.getElementById('deposit-screenshot-upload').files;
                    if (upload.length === 0) {
                        App.showAlert('Please upload a screenshot file (simulated).', 'danger');
                        return;
                    }
                    
                    // Simulation of detection
                    App.showLoader("Analyzing deposit (simulated)...");
                    setTimeout(() => {
                        App.hideLoader();
                        App.showAlert("Deposit confirmed (simulated). Starting session!", 'success');
                        
                        const license = DB.getAllLicenses().find(l => l.key === document.getElementById('license-key-input').value);
                        Predictor.startPredictionEngine(license);
                    }, 2000);
                },
                
                startPredictionEngine(license) {
                    App.activeLicense = license;
                    document.getElementById('engine-title').textContent = `${license.type.charAt(0).toUpperCase() + license.type.slice(1)} Predictor`;
                    document.getElementById('engine-prediction-value').textContent = '--.--x';
                    document.getElementById('engine-next-btn').disabled = false;
                    document.getElementById('engine-cooldown-text').textContent = '';
                    
                    const updateTimer = () => {
                        const now = Date.now();
                        const remaining = App.activeLicense.expiry - now;
                        
                        if (remaining <= 0) {
                            Predictor.expireSession();
                            return;
                        }
                        
                        const h = Math.floor(remaining / 3600000);
                        const m = Math.floor((remaining % 3600000) / 60000);
                        const s = Math.floor((remaining % 60000) / 1000);
                        
                        document.getElementById('engine-countdown').textContent = 
                            `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    };
                    
                    if (App.sessionTimer) clearInterval(App.sessionTimer);
                    App.sessionTimer = setInterval(updateTimer, 1000);
                    updateTimer();
                    
                    App.showPage('page-user-predictor-engine');
                },
                
                getNextPrediction() {
                    document.getElementById('engine-next-btn').disabled = true;
                    document.getElementById('engine-prediction-value').textContent = '...';
                    
                    const cooldown = Math.floor(Math.random() * 6) + 15; // 15-20 seconds
                    let cooldownLeft = cooldown;
                    
                    const cooldownInterval = setInterval(() => {
                        cooldownLeft--;
                        document.getElementById('engine-cooldown-text').textContent = `Next prediction available in ${cooldownLeft}s...`;
                        if (cooldownLeft <= 0) {
                            clearInterval(cooldownInterval);
                        }
                    }, 1000);

                    App.predictionCooldown = setTimeout(() => {
                        const prediction = (Math.random() * 4.0) + 1.0; // 1.0x to 5.0x
                        document.getElementById('engine-prediction-value').textContent = `${prediction.toFixed(2)}x`;
                        document.getElementById('engine-next-btn').disabled = false;
                        document.getElementById('engine-cooldown-text').textContent = `Prediction is ready!`;
                    }, cooldown * 1000);
                },
                
                expireSession() {
                    if (App.sessionTimer) clearInterval(App.sessionTimer);
                    if (App.predictionCooldown) clearTimeout(App.predictionCooldown);
                    
                    App.showAlert("Your prediction session has expired.", 'warning');
                    App.activeLicense = null;
                    App.showPage('page-user-predictors');
                    UI.renderUserDashboard(); // Refresh license list
                },
                
                exitEngine() {
                    // Doesn't stop timer, just exits page
                    App.showPage('page-user-dashboard');
                }
            };

            // --- 6. REFERRAL SYSTEM ---
            const Referral = {
                renderReferralPage() {
                    const user = App.currentUser;
                    const link = `${window.location.origin}${window.location.pathname}?ref=${user.refCode}`;
                    document.getElementById('referral-link-input').value = link;
                    
                    const referrals = DB.getAllUsers().filter(u => u.referredBy === user.refCode);
                    const activeReferrals = referrals.filter(u => !u.isSuspended); // Simple logic
                    
                    const earnings = Referral.calculateTotalEarnings(user.email);
                    document.getElementById('ref-stat-earnings').textContent = `KES ${earnings.toFixed(2)}`;
                    document.getElementById('ref-stat-total').textContent = referrals.length;
                    document.getElementById('ref-stat-active').textContent = activeReferrals.length;
                    document.getElementById('ref-stat-points').textContent = user.points;
                    
                    UI.renderMockChart('referral-chart-mock', 12, 5); // 12 months, max 5 referrals
                    
                    const tableBody = document.getElementById('referral-table').querySelector('tbody');
                    if (referrals.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">You haven't referred anyone yet.</td></tr>`;
                    } else {
                        tableBody.innerHTML = referrals.map(ref => {
                            const status = ref.isSuspended ? '<span class="badge badge-danger">Suspended</span>' : (ref.premiumTier ? '<span class="badge badge-premium">Premium</span>' : '<span class="badge badge-success">Active</span>');
                            // Mock commission
                            const commission = (DB.getAllPayments().filter(p => p.userId === ref.email && p.status === 'used').reduce((sum, p) => sum + p.amount, 0)) * 0.10;
                            return `
                                <tr>
                                    <td>${ref.email.substring(0, 3)}***@gmail.com</td>
                                    <td>${status}</td>
                                    <td>KES ${commission.toFixed(2)}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                },
                
                copyReferralLink() {
                    const input = document.getElementById('referral-link-input');
                    input.select();
                    try {
                        document.execCommand('copy');
                        App.showAlert('Referral link copied!', 'success');
                    } catch (err) {
                        App.showAlert('Failed to copy link.', 'danger');
                    }
                },
                
                calculateTotalEarnings(userEmail) {
                    const user = DB.getUserByEmail(userEmail);
                    if (!user) return 0;
                    const referrals = DB.getAllUsers().filter(u => u.referredBy === user.refCode);
                    let totalEarnings = 0;
                    referrals.forEach(ref => {
                        const payments = DB.getAllPayments().filter(p => p.userId === ref.email && (p.status === 'approved' || p.status === 'used'));
                        payments.forEach(p => {
                            totalEarnings += p.amount * 0.10; // 10% commission
                        });
                    });
                    return totalEarnings;
                }
            };
            
            // --- 7. SUPPORT SYSTEM ---
            const Support = {
                openWhatsApp() {
                    // The href is set dynamically in UI.buildApp
                },
                showSupportModal() {
                    const assistant = DB.getAllUsers().find(u => u.role === 'assistant');
                    const assistantStatus = assistant && assistant.isOnDuty ? '<span class="badge badge-success">Online</span>' : '<span class="badge badge-inactive">Offline</span>';
                    
                    const body = `
                        <p>How can we help you?</p>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <div><strong>Admin on Duty</strong> ${assistantStatus}</div>
                                <button class="btn btn-sm btn-primary" id="support-choice-assistant">Chat</button>
                            </li>
                            <li class="list-group-item">
                                <div><strong>System Help</strong> (Escalate to Super Admin)</div>
                                <button class="btn btn-sm btn-secondary" id="support-choice-super">Send Message</button>
                            </li>
                            <li class="list-group-item">
                                <div><strong>Global WhatsApp</strong></div>
                                <button class="btn btn-sm btn-secondary" id="support-choice-whatsapp">Open WA</button>
                            </li>
                        </ul>
                    `;
                    App.showModal('Support Center', body, []);
                    
                    // Add listeners to modal buttons
                    document.getElementById('support-choice-assistant').addEventListener('click', () => {
                        App.hideModal();
                        App.showAlert("Connecting to Assistant (simulated)...", 'success');
                    });
                    document.getElementById('support-choice-super').addEventListener('click', () => {
                        App.hideModal();
                        App.showAlert("Message sent to Super Admin (simulated).", 'success');
                    });
                    document.getElementById('support-choice-whatsapp').addEventListener('click', () => {
                        App.hideModal();
                        document.getElementById('whatsapp-btn').click(); // Triggers global WA link
                    });
                }
            };

            // --- 8. ADMIN ---
            const Admin = {
                renderDashboard() {
                    const payments = DB.getAllPayments();
                    const users = DB.getAllUsers();
                    
                    const totalRevenue = payments
                        .filter(p => p.status === 'approved' || p.status === 'used')
                        .reduce((sum, p) => sum + p.amount, 0);
                    document.getElementById('admin-stat-revenue').textContent = `KES ${totalRevenue.toFixed(2)}`;
                    
                    // Mock active users
                    document.getElementById('admin-stat-active-users').textContent = users.filter(u => !u.isSuspended).length;
                    
                    document.getElementById('admin-stat-pending-payments').textContent = payments.filter(p => p.status === 'pending').length;
                    document.getElementById('admin-stat-premium-users').textContent = users.filter(u => u.premiumTier).length;
                    
                    UI.renderMockChart('admin-chart-mock', 7, 10000); // 7 days, max 10k revenue
                },
                
                renderPaymentList() {
                    const payments = DB.getAllPayments().sort((a, b) => b.submittedAt - a.submittedAt);
                    const tableBody = document.getElementById('admin-payments-table').querySelector('tbody');
                    if (payments.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No payments found.</td></tr>';
                        return;
                    }
                    tableBody.innerHTML = payments.map(p => `
                        <tr>
                            <td>${p.userId}</td>
                            <td>${p.txId}</td>
                            <td>KES ${p.amount.toFixed(2)}</td>
                            <td>${p.type}</td>
                            <td><span class="badge badge-${p.status === 'pending' ? 'warning' : (p.status === 'approved' || p.status === 'used' ? 'success' : 'danger')}">${p.status}</span></td>
                            <td>
                                ${p.status === 'pending' ? `
                                    <div class="action-btns">
                                        <button class="btn btn-sm btn-primary" data-action="admin-approve-payment" data-id="${p.id}">Approve</button>
                                        <button class="btn btn-sm btn-danger" data-action="admin-reject-payment" data-id="${p.id}">Reject</button>
                                    </div>
                                ` : (p.status === 'rejected' ? `By ${p.rejectedBy || 'N/A'}` : `By ${p.approvedBy || 'N/A'}`)}
                            </td>
                        </tr>
                    `).join('');
                },
                
                approvePayment(paymentId) {
                    const payment = DB.updatePayment(paymentId, { status: 'approved', approvedBy: App.currentUser.email, approvedAt: Date.now() });
                    DB.logAction(App.currentUser.email, 'Approved Payment', `ID: ${payment.id}, TX: ${payment.txId}, User: ${payment.userId}`);
                    App.showAlert('Payment approved!', 'success');
                    Admin.renderPaymentList();
                    Admin.renderDashboard(); // Refresh stats
                },
                
                showRejectModal(paymentId) {
                    const body = `
                        <p>Please provide a reason for rejecting this payment.</p>
                        <div class="form-group">
                            <label for="reject-reason">Reason</label>
                            <input type="text" id="reject-reason" class="form-group" placeholder="e.g., Invalid TX ID">
                        </div>
                    `;
                    const buttons = [
                        { text: 'Cancel', class: 'btn-secondary', action: App.hideModal },
                        { text: 'Reject Payment', class: 'btn-danger', action: () => Admin.rejectPayment(paymentId) }
                    ];
                    App.showModal('Reject Payment', body, buttons);
                },
                
                rejectPayment(paymentId) {
                    const reason = document.getElementById('reject-reason').value || 'No reason provided';
                    const payment = DB.updatePayment(paymentId, { status: 'rejected', reason: reason, rejectedBy: App.currentUser.email, rejectedAt: Date.now() });
                    DB.logAction(App.currentUser.email, 'Rejected Payment', `ID: ${payment.id}, TX: ${payment.txId}, User: ${payment.userId}, Reason: ${reason}`);
                    App.showAlert('Payment rejected.', 'success');
                    Admin.renderPaymentList();
                    App.hideModal();
                },
                
                renderUserList() {
                    const users = DB.getAllUsers();
                    const tableBody = document.getElementById('admin-users-table').querySelector('tbody');
                    tableBody.innerHTML = users.map(u => {
                        const isStaff = u.role === 'admin' || u.role === 'super-admin';
                        return `
                            <tr>
                                <td>${u.email}</td>
                                <td><span class="badge badge-${u.role === 'admin' ? 'admin' : (u.role === 'super-admin' ? 'super' : (u.role === 'assistant' ? 'assistant' : 'inactive'))}">${u.role}</span></td>
                                <td><span class="badge ${u.isSuspended ? 'badge-danger' : 'badge-success'}">${u.isSuspended ? 'Suspended' : 'Active'}</span></td>
                                <td>${u.premiumTier ? `<span class="badge badge-premium">${u.premiumTier}</span>` : 'N/A'}</td>
                                <td>
                                    <div class="action-btns">
                                        ${u.isSuspended ? 
                                            `<button class="btn btn-sm btn-primary" data-action="admin-unban-user" data-id="${u.email}" ${isStaff ? 'disabled' : ''}>Unban</button>` : 
                                            `<button class="btn btn-sm btn-danger" data-action="admin-ban-user" data-id="${u.email}" ${isStaff ? 'disabled' : ''}>Ban</button>`
                                        }
                                        <button class="btn btn-sm btn-secondary" data-action="admin-grant-premium" data-id="${u.email}">Award</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                },
                
                showBanModal(email) {
                    const body = `
                        <p>Provide a reason for banning <strong>${email}</strong>.</p>
                        <div class="form-group">
                            <label for="ban-reason">Reason</label>
                            <input type="text" id="ban-reason" class="form-group" placeholder="e.g., Fraudulent activity">
                        </div>
                    `;
                    const buttons = [
                        { text: 'Cancel', class: 'btn-secondary', action: App.hideModal },
                        { text: 'Ban User', class: 'btn-danger', action: () => Admin.banUser(email) }
                    ];
                    App.showModal('Ban User', body, buttons);
                },
                
                banUser(email) {
                    const reason = document.getElementById('ban-reason').value || 'No reason provided';
                    DB.updateUser(email, { isSuspended: true, suspendReason: reason });
                    DB.logAction(App.currentUser.email, 'Banned User', `User: ${email}, Reason: ${reason}`);
                    App.showAlert('User banned.', 'success');
                    Admin.renderUserList();
                    App.hideModal();
                },
                
                unbanUser(email) {
                    DB.updateUser(email, { isSuspended: false, suspendReason: '' });
                    DB.logAction(App.currentUser.email, 'Unbanned User', `User: ${email}`);
                    App.showAlert('User unbanned.', 'success');
                    Admin.renderUserList();
                },
                
                showGrantPremiumModal(email) {
                    const body = `
                        <p>Grant premium access to <strong>${email}</strong>.</p>
                        <div class="form-group">
                            <label for="premium-tier">Tier</label>
                            <select id="premium-tier" class="form-group" style="width: 100%; padding: 0.85rem 1rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                <option value="low">Low Premium</option>
                                <option value="mid">Mid Premium</option>
                                <option value="high">High Premium</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="premium-duration">Duration (in days)</label>
                            <input type="number" id="premium-duration" class="form-group" value="30">
                        </div>
                    `;
                    const buttons = [
                        { text: 'Cancel', class: 'btn-secondary', action: App.hideModal },
                        { text: 'Grant Access', class: 'btn-primary', action: () => Admin.grantPremium(email) }
                    ];
                    App.showModal('Grant Premium', body, buttons);
                },
                
                grantPremium(email) {
                    const tier = document.getElementById('premium-tier').value;
                    const duration = parseInt(document.getElementById('premium-duration').value);
                    const expiry = Date.now() + duration * 24 * 60 * 60 * 1000;
                    
                    DB.updateUser(email, { premiumTier: tier, premiumExpiry: expiry });
                    DB.logAction(App.currentUser.email, 'Granted Premium', `User: ${email}, Tier: ${tier}, Days: ${duration}`);
                    App.showAlert('Premium access granted.', 'success');
                    Admin.renderUserList();
                    App.hideModal();
                },
                
                loadSettings() {
                    const settings = DB.getSettings();
                    document.getElementById('settings-whatsapp').value = settings.whatsapp;
                    document.getElementById('settings-paybill').value = settings.payment.paybill;
                    document.getElementById('settings-account').value = settings.payment.account;
                    document.getElementById('settings-price-crash').value = settings.prices.crash;
                    document.getElementById('settings-price-gems').value = settings.prices.gems;
                    document.getElementById('settings-price-mines').value = settings.prices.mines;
                    document.getElementById('settings-price-odds').value = settings.prices.odds;
                    document.getElementById('settings-price-low').value = settings.premium.low;
                    document.getElementById('settings-price-mid').value = settings.premium.mid;
                    document.getElementById('settings-price-high').value = settings.premium.high;
                },
                
                saveSettings() {
                    const newSettings = {
                        whatsapp: document.getElementById('settings-whatsapp').value,
                        payment: {
                            paybill: document.getElementById('settings-paybill').value,
                            account: document.getElementById('settings-account').value,
                        },
                        prices: {
                            crash: parseFloat(document.getElementById('settings-price-crash').value),
                            gems: parseFloat(document.getElementById('settings-price-gems').value),
                            mines: parseFloat(document.getElementById('settings-price-mines').value),
                            odds: parseFloat(document.getElementById('settings-price-odds').value),
                        },
                        premium: {
                            low: parseFloat(document.getElementById('settings-price-low').value),
                            mid: parseFloat(document.getElementById('settings-price-mid').value),
                            high: parseFloat(document.getElementById('settings-price-high').value),
                        }
                    };
                    DB.setSettings(newSettings);
                    DB.logAction(App.currentUser.email, 'Updated Settings', JSON.stringify(newSettings));
                    App.showAlert('Settings saved successfully!', 'success');
                },
                
                showBroadcastModal() {
                    // This is an Admin/SuperAdmin action
                    App.showAlert("Broadcast modal (simulated)", 'success');
                },
                
                showGenerateAssistantModal() {
                    // This is an Admin/SuperAdmin action
                    App.showAlert("Generate assistant modal (simulated)", 'success');
                }
            };

            // --- 9. SUPER ADMIN ---
            const SuperAdmin = {
                renderDashboard() {
                    const payments = DB.getAllPayments();
                    const users = DB.getAllUsers();
                    
                    const totalRevenue = payments
                        .filter(p => p.status === 'approved' || p.status === 'used')
                        .reduce((sum, p) => sum + p.amount, 0);
                    document.getElementById('super-stat-revenue').textContent = `KES ${totalRevenue.toFixed(2)}`;
                    
                    document.getElementById('super-stat-users').textContent = users.length;
                    
                    const conversions = (users.filter(u => u.premiumTier).length / users.length) * 100;
                    document.getElementById('super-stat-conversions').textContent = `${conversions.toFixed(1)}%`;
                    
                    document.getElementById('super-stat-trends').textContent = "Growing"; // Mock
                    
                    UI.renderMockChart('super-chart-mock', 30, 20000); // 30 days, max 20k
                },
                
                renderAuditLog() {
                    const log = DB.getAuditLog().sort((a, b) => b.timestamp - a.timestamp);
                    const tableBody = document.getElementById('super-audit-table').querySelector('tbody');
                    if (log.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No audit log found.</td></tr>';
                        return;
                    }
                    tableBody.innerHTML = log.map(l => `
                        <tr>
                            <td>${new Date(l.timestamp).toLocaleString()}</td>
                            <td>${l.admin}</td>
                            <td>${l.action}</td>
                            <td>${l.details}</td>
                        </tr>
                    `).join('');
                },
                
                renderManageAdmins() {
                    const users = DB.getAllUsers();
                    const tableBody = document.getElementById('super-manage-table').querySelector('tbody');
                    tableBody.innerHTML = users.map(u => {
                        const isSuper = u.role === 'super-admin';
                        return `
                            <tr>
                                <td>${u.email}</td>
                                <td><span class="badge badge-${u.role === 'admin' ? 'admin' : (u.role === 'super-admin' ? 'super' : (u.role === 'assistant' ? 'assistant' : 'inactive'))}">${u.role}</span></td>
                                <td><span class="badge ${u.isSuspended ? 'badge-danger' : 'badge-success'}">${u.isSuspended ? 'Suspended' : 'Active'}</span></td>
                                <td>
                                    <div class="action-btns">
                                        ${u.role === 'user' ? `
                                            <button class="btn btn-sm btn-primary" data-action="super-promote-admin" data-id="${u.email}">Make Admin</button>
                                            <button class="btn btn-sm btn-secondary" data-action="super-promote-assistant" data-id="${u.email}">Make Assistant</button>
                                        ` : `
                                            <button class="btn btn-sm btn-danger" data-action="super-demote-user" data-id="${u.email}" ${isSuper ? 'disabled' : ''}>Demote to User</button>
                                        `}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                },
                
                showManageRoleModal(email, role) {
                    let durationInput = '';
                    if (role === 'assistant') {
                        durationInput = `
                            <div class="form-group">
                                <label for="role-duration">Duration (in days)</label>
                                <input type="number" id="role-duration" class="form-group" value="30">
                            </div>
                        `;
                    }
                    const body = `
                        <p>Promote <strong>${email}</strong> to <strong>${role}</strong>?</p>
                        ${durationInput}
                    `;
                    const buttons = [
                        { text: 'Cancel', class: 'btn-secondary', action: App.hideModal },
                        { text: 'Promote', class: 'btn-primary', action: () => SuperAdmin.promoteToRole(email, role) }
                    ];
                    App.showModal(`Promote to ${role}`, body, buttons);
                },
                
                promoteToRole(email, role) {
                    let expiry = null;
                    if (role === 'assistant') {
                        const duration = parseInt(document.getElementById('role-duration').value);
                        expiry = Date.now() + duration * 24 * 60 * 60 * 1000;
                    }
                    DB.updateUser(email, { role: role, assistantExpiry: expiry });
                    DB.logAction(App.currentUser.email, 'Promoted User', `User: ${email}, New Role: ${role}`);
                    App.showAlert('User promoted.', 'success');
                    SuperAdmin.renderManageAdmins();
                    App.hideModal();
                },
                
                demoteToUser(email) {
                    DB.updateUser(email, { role: 'user', assistantExpiry: null });
                    DB.logAction(App.currentUser.email, 'Demoted User', `User: ${email}, New Role: user`);
                    App.showAlert('User demoted.', 'success');
                    SuperAdmin.renderManageAdmins();
                }
            };
            
            // --- 10. APP INITIALIZATION ---
            App.init();

        });
    </script>
</body>
</html>
